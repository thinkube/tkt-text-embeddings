FROM {{ container_registry }}/library/text-embeddings-inference-base:1.5-blackwell

# TEI base image already has:
# - text-embeddings-router binary
# - CUDA 13.0 runtime
# - Configured for Blackwell (sm_121a)

# Install Python and Gradio dependencies
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Copy and install requirements
COPY requirements.txt /app/requirements.txt
RUN pip3 install --no-cache-dir --break-system-packages --upgrade -r /app/requirements.txt

# Copy application files
COPY entrypoint.sh /app/entrypoint.sh
COPY server.py /app/server.py
COPY thinkube_theme.py /app/thinkube_theme.py
RUN chmod +x /app/entrypoint.sh

# Copy assets
RUN mkdir -p /app/icons
COPY tk_ai.png /app/icons/tk_ai.png
COPY tk_ai.svg /app/icons/tk_ai.svg

# Switch back to non-root user
USER tei
WORKDIR /app

# Model ID passed as environment variable at deployment time
# Not baked into the image to enable image reuse across deployments

# Expose ports: 8355 for TEI API, 7860 for Gradio UI
EXPOSE 8355 7860

# Run the entrypoint script
ENTRYPOINT ["/app/entrypoint.sh"]
